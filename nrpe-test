- hosts: linux
  become: yes
  tasks:
    - name: install packages
        state: present
        name:
         - nagios-nrpe-server 
         - nagios-plugins
      state: latest
        
    - name: creer les identifiants de connexion
      lineinfile:
        path: /etc/nagios/nrpe.cfg
        regexp::'^(.*) allowed_hosts=127.0.0.1,(.*)$' 
        line: ' allowed_hosts=127.0.0.1, 192.168.1.100'
        firstmatch: yes
      when: not out.found
      register: allowed
      
    - name: creer les plugins
      lineinfile:
        path: /etc/nagios/nrpe.cfg
        insertafter: '^ example of commands '
        line: "command[check_isfile]=/usr/lib/nagios/plugins/check_isfile"
        firstmatch: yes
      when: not out.found
      register: command
        
 name: Start service nagios-nrpe,
      service:
        name: nagios-nrpe-server
        state: start
      when: ( allowed.changed ) or (command.changed  )
      
 name: Retart service nagios-nrpe,
      service:
        name: nagios-nrpe-server
        state: restart
      when: ( allowed.changed ) or (command.changed  )

 name: status service nagios-nrpe,
      service:
        name: nagios-nrpe-server
        state: status
      when: ( allowed.changed ) or (command.changed  )

     - name: Creating a file with content
      copy:
        dest: "/ur/lib/nagios/plugin/check_isfile"
        content: |
          #!/bin/bash
          #file='cat /var/run/reboot-required'
          if cat /var/run/reboot-required | grep -q 'restart' || cat /var/run/reboot-required | grep -q 'syst√®me'; then
          echo "CRITICAL - reboot  needed"
          exit 1
          else
          echo "OK - Reboot not Needed"
          exit 0
          fi     

     - name: Changing perm of "/foo/bar.sh", adding "+x"
      file: dest=/ur/lib/nagios/plugin mode=a+x
        
